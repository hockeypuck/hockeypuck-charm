#!/bin/bash -e

CWD=$(pwd)

# Install the binary
install -m 0755 files/hockeypuck /usr/bin/hockeypuck

# Install the package files
(cd /; tar xzvf $CWD/files/instroot.tar.gz)
rm /etc/init.d/hockeypuck  # Remove the sysvinit script, use upstart instead

# Fake some debian packaging stuff
DEBDIR=$(mktemp -d)
(cd $DEBDIR; tar xzvf $CWD/files/debian.tar.gz)
install -m 0644 $DEBDIR/upstart /etc/init/hockeypuck.conf
$DEBDIR/postinst

rm -rf /var/lib/hockeypuck/recon-ptree
mkdir -p /var/lib/hockeypuck/recon-ptree
chown -R hockeypuck:hockeypuck /var/lib/hockeypuck/recon-ptree

mkdir -p /etc/hockeypuck/hockeypuck.conf.d

cat >/etc/hockeypuck/hockeypuck.conf.d/00-warn <<EOF
# Generated by hockeypuck charm install hook
# DO NOT EDIT
EOF

cat >/etc/hockeypuck/hockeypuck.conf.d/01-base <<EOF

[hockeypuck]
logfile="/var/log/hockeypuck/hockeypuck.log"

[hockeypuck.hkp]
bind=":11371"
webroot="/var/lib/hockeypuck/www"

[conflux.recon.leveldb]
path="/var/lib/hockeypuck/recon-ptree"

EOF

# Whoa there, I said, whoa!
service hockeypuck stop || true
